name: Security CI - Self-Healing Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: write

jobs:
  security-scan:
    runs-on: ubuntu-latest
    name: Security Assessment & Auto-Fix

    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis

    - name: üîß Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: üêç Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: üì¶ Install dependencies
      run: |
        npm ci --ignore-scripts
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi

    # ===== STAGE 1: Critical Security Scanners =====

    - name: üîç Scan for secrets (Gitleaks)
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true

    - name: üîç Python SAST (Bandit)
      run: |
        pip install bandit
        bandit -r . -f json -o bandit-results.json || true
      continue-on-error: true

    - name: üîç Dependency audit (npm)
      run: |
        npm audit --json > npm-audit-results.json || true
        echo "npm_audit_status=$?" >> $GITHUB_ENV
      continue-on-error: true

    - name: üîç Python dependencies (Safety)
      run: |
        pip install safety
        safety check --json > safety-results.json || true
      continue-on-error: true
      if: hashFiles('requirements.txt') != ''

    # ===== STAGE 2: SAST Scanners =====

    - name: üîç SAST scan (Semgrep)
      uses: returntocorp/semgrep-action@v1
      with:
        config: auto
      continue-on-error: true

    - name: üîç ESLint
      run: |
        npx eslint . --format json --output-file eslint-results.json || true
      continue-on-error: true

    # ===== STAGE 3: Infrastructure Scanners =====

    - name: üîç Container scanning (Trivy)
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        format: 'json'
        output: 'trivy-results.json'
      continue-on-error: true

    - name: üîç IaC scanning (Checkov)
      uses: bridgecrewio/checkov-action@master
      with:
        directory: .
        framework: all
        output_format: json
        output_file_path: checkov-results.json
      continue-on-error: true

    # ===== AUTO-FIX STAGE =====

    - name: üîß Auto-fix issues (Stage 1)
      run: |
        # Fix dependencies
        if [ -f package.json ]; then
          npm audit fix --force || true
        fi

        # Fix code quality
        npx eslint . --fix || true

        # Fix Python formatting
        if command -v autopep8 &> /dev/null; then
          find . -name "*.py" -exec autopep8 --in-place --aggressive --aggressive {} + || true
        fi

        # Fix Python with black
        if command -v black &> /dev/null; then
          black . || true
        fi

        # Fix with ruff
        if command -v ruff &> /dev/null; then
          ruff check --fix . || true
        fi

    - name: üìä Check if fixes were applied
      id: check_fixes
      run: |
        if [[ -n $(git status -s) ]]; then
          echo "fixes_applied=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Auto-fixes were applied"
        else
          echo "fixes_applied=false" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è  No auto-fixes needed"
        fi

    - name: üíæ Commit auto-fixes
      if: steps.check_fixes.outputs.fixes_applied == 'true'
      run: |
        git config --local user.email "security-bot@example.com"
        git config --local user.name "Security Bot"
        git add .
        git commit -m "ü§ñ Auto-fix: Security and code quality improvements

        Applied automated fixes:
        - npm audit fix (dependency updates)
        - eslint --fix (code quality)
        - autopep8/black (Python formatting)
        - ruff --fix (Python linting)

        Co-Authored-By: Security CI <security-bot@example.com>"

    - name: üöÄ Push fixes
      if: steps.check_fixes.outputs.fixes_applied == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}

    # ===== UPLOAD RESULTS =====

    - name: üì§ Upload scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results
        path: |
          *-results.json
        retention-days: 30

    # ===== FAILURE NOTIFICATION =====

    - name: üö® Comment on PR with results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          let comment = '## üîí Security Scan Results\n\n';

          // Parse results
          try {
            if (fs.existsSync('bandit-results.json')) {
              const bandit = JSON.parse(fs.readFileSync('bandit-results.json', 'utf8'));
              comment += `### Bandit (Python SAST)\n`;
              comment += `- Issues found: ${bandit.results?.length || 0}\n\n`;
            }

            if (fs.existsSync('npm-audit-results.json')) {
              const npm = JSON.parse(fs.readFileSync('npm-audit-results.json', 'utf8'));
              const vulns = npm.metadata?.vulnerabilities || {};
              comment += `### NPM Audit\n`;
              comment += `- Critical: ${vulns.critical || 0}\n`;
              comment += `- High: ${vulns.high || 0}\n`;
              comment += `- Moderate: ${vulns.moderate || 0}\n\n`;
            }
          } catch (e) {
            comment += `\n‚ö†Ô∏è  Error parsing results: ${e.message}\n`;
          }

          comment += '\n---\n';
          comment += 'ü§ñ *Automated security scan by GP-CONSULTING Security CI*';

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # ===== AI FIX LOOP (Stage 2) =====

  ai-fix-loop:
    runs-on: ubuntu-latest
    needs: security-scan
    if: failure()
    name: AI-Powered Fix Attempt

    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4

    - name: üêç Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ü§ñ Run Stage 2 AI fixes
      run: |
        echo "ü§ñ AI-powered fix loop would run here"
        echo "This requires:"
        echo "  1. Access to Ollama API"
        echo "  2. JADE RAG system"
        echo "  3. Secure secrets management"
        echo ""
        echo "For now, escalate to manual review"

    - name: üìß Notify for manual review
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'üö® Security Issues Require Manual Review',
            body: 'Automated fixes could not resolve all security issues. Please review the scan results and apply fixes manually.',
            labels: ['security', 'needs-review']
          });
