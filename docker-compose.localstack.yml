version: '3.8'

services:
  localstack:
    image: localstack/localstack:3.0.2
    container_name: ai-powered-localstack
    hostname: localstack

    ports:
      - "127.0.0.1:4566:4566"  # LocalStack gateway (all AWS services)

    environment:
      # AWS Services enabled for this project
      - SERVICES=bedrock,dynamodb,elasticache,lambda,rds,s3,secretsmanager,sqs

      # Debug mode for development
      - DEBUG=1

      # Persist data across restarts
      - PERSISTENCE=1
      - DATA_DIR=/var/lib/localstack/data

      # AWS region
      - DEFAULT_REGION=us-east-1

      # Lambda configuration
      - LAMBDA_EXECUTOR=docker-reuse
      - LAMBDA_REMOTE_DOCKER=false
      - DISABLE_EVENTS=0  # Enable event triggers

      # DynamoDB configuration
      - DYNAMODB_SHARE_DB=1
      - DYNAMODB_HEAP_SIZE=256m

      # S3 configuration (validate signatures for security)
      - S3_SKIP_SIGNATURE_VALIDATION=0

      # Pass secrets to LocalStack for initialization
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY:-}
      - HUME_API_KEY=${HUME_API_KEY:-}
      - HUME_SECRET_KEY=${HUME_SECRET_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - ARCJET_KEY=${ARCJET_KEY:-}

    volumes:
      # Persist LocalStack data
      - ./localstack-data:/var/lib/localstack

      # Docker socket for Lambda execution (WARNING: Gives container root access)
      # Consider using alternatives for production
      - /var/run/docker.sock:/var/run/docker.sock

      # Initialization scripts (auto-create S3 buckets, DynamoDB tables, etc.)
      - ./localstack-init:/etc/localstack/init:ro

    # Security hardening
    security_opt:
      - no-new-privileges:true

    # Restart policy
    restart: unless-stopped

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4566/_localstack/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  localstack_data:
    driver: local
